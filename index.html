<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Seazencity Lamp Setup</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="wrap">
    <h1>Seazencity Lamp Setup</h1>
    <p class="muted">
      Этот PWA ведёт по пути AP → Wi‑Fi (STA) и показывает диагностику запросов к WLED прямо на экране.
      Если WLED ещё не настроен, начни с шага 1.
    </p>

    <div class="chips">
      <span class="chip" id="chipOrigin">Origin: -</span>
      <span class="chip" id="chipProto">Protocol: -</span>
      <span class="chip" id="chipSW">SW: -</span>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2>Шаг 1 - Подключись к Wi‑Fi лампы (AP)</h2>
      <p class="muted">
        SSID: <b>seazencity</b>. Пароль: <b>пустой</b>.
        PWA не может переключить Wi‑Fi сам, это делается в настройках телефона.
      </p>

      <div class="row">
        <button class="btn" id="btnOpenWifi">Открыть настройки Wi‑Fi</button>
        <button class="btn" id="btnOpenAp">Открыть страницу лампы (http://4.3.2.1)</button>
      </div>

      <p class="muted small">
        Если кнопка настройки Wi‑Fi не сработала, открой настройки Wi‑Fi вручную и подключись к <b>seazencity</b>.
      </p>
    </section>

    <section class="card">
      <h2>Шаг 2 - Дай лампе Wi‑Fi (STA)</h2>
      <ol class="muted">
        <li>Открой страницу лампы <b>http://4.3.2.1</b>.</li>
        <li>Найди <b>WiFi Setup</b>.</li>
        <li>Введи SSID и пароль твоего Wi‑Fi.</li>
        <li>Нажми <b>Save &amp; Connect</b> (лампа перезагрузится и уйдёт в Wi‑Fi).</li>
      </ol>

      <div class="row">
        <button class="btn primary" id="btnIConnected">Я нажал Save &amp; Connect</button>
        <button class="btn" id="btnOpenApWifiSetup">Открыть сразу WiFi Setup</button>
      </div>

      <p class="muted small">
        В момент переключения AP пропадёт. Это нормально.
      </p>
    </section>

    <section class="card">
      <h2>Шаг 3 - Найти лампу в Wi‑Fi (STA)</h2>

      <p class="muted">
        Если mDNS включён, лампа доступна по имени <b>seazencity.local</b>.
        Если не открывается, используй IP (можно посмотреть в WLED app или в списке клиентов хотспота).
      </p>

      <div class="field">
        <label for="hostInput">WLED host (без http://). Примеры: <span class="mono">seazencity.local</span> или <span class="mono">10.183.228.118</span></label>
        <input id="hostInput" inputmode="url" autocomplete="off" spellcheck="false" />
      </div>

      <div class="row">
        <button class="btn" id="btnTryMdns">Подставить seazencity.local</button>
        <button class="btn" id="btnOpenHost">Открыть WLED в браузере</button>
      </div>

      <div class="row">
        <button class="btn" id="btnGetInfo">GET /json/info</button>
        <button class="btn" id="btnToggle">POST /json/state (toggle)</button>
      </div>

      <div class="status">
        <div class="chip wide" id="chipResult">RESULT: idle</div>
        <div class="chip wide" id="chipLastUrl">Last URL: -</div>
      </div>

      <div class="diag">
        <h3>Human diagnosis</h3>
        <div class="pre" id="humanDiag">-</div>
        <h3>Raw details</h3>
        <div class="pre" id="rawDiag">-</div>
      </div>

      <details class="muted small">
        <summary>Если Chrome спросит разрешение</summary>
        <div class="small">
          Иногда Chrome/Android показывает системный запрос, связанный с доступом к устройствам в локальной сети.
          Если всплыло разрешение, нажми <b>Allow</b>, затем повтори запрос.
          Если разрешение было отклонено, может помочь очистка разрешений для сайта или переустановка PWA.
          Это гипотеза, конкретное поведение зависит от версии Chrome и Android.
        </div>
      </details>
    </section>

    <section class="card">
      <h2>Проверка кеша (без отключения интернета)</h2>
      <p class="muted">
        Тест Service Worker кеша: fetch на <span class="mono">./cache-test.txt</span>.
      </p>

      <div class="row">
        <button class="btn" id="btnCacheTest">Cache-test: fetch ./cache-test.txt</button>
        <button class="btn" id="btnForceUpdate">Force update SW + reload</button>
      </div>

      <div class="diag">
        <h3>Cache-test output</h3>
        <div class="pre" id="cacheOut">-</div>
      </div>

      <p class="muted small">
        Если изменения после обновления файлов на GitHub не видны, причина часто в старом Service Worker.
      </p>
    </section>
  </main>

  <footer class="wrap muted small">
    Версия UI: <span class="mono" id="uiVer">-</span>
  </footer>

  <script src="./app.js"></script>
</body>
</html>
